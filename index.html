<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë„ì°©ì§€ ìë™ì™„ì„± & ëŒ€ì¤‘êµí†µ ê²½ë¡œ</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    #search-panel { background: white; padding: 10px; width: 300px; box-shadow: 0 0 10px rgba(0,0,0,0.2); margin: 20px auto; }
    .result-list { list-style: none; padding: 0; margin: 5px 0; max-height: 150px; overflow-y: auto; background: #f9f9f9; border: 1px solid #ccc; }
    .result-list li { padding: 5px; cursor: pointer; border-bottom: 1px solid #ddd; }
    .result-list li:hover { background: #e9e9e9; }
    #route-result { padding: 10px; max-width: 700px; margin: 20px auto; background: #f0f0f0; border-radius: 8px; }
    .bus-arrival { margin-left: 10px; color: #0066cc; font-size: 0.9em; }
  </style>
</head>
<body>
  <div id="search-panel">
    <input type="text" id="end" placeholder="ë„ì°©ì§€ ì…ë ¥" />
    <ul id="end-results" class="result-list"></ul>
  </div>
  <div id="route-result"></div>

<script>
  const appKey = 'z1X5bjuncu1DaI5iBjpsr4lNU0JKTgEV9EqYsp50';
  const busanServiceKey = 'AkitlNBJDUtLzeFfwjIH1dYllDkQN70sg4eveRlW8Vz8E6C3OCL%2Bh%2F4bn6SB0CK2cw9H8LoWgzzkp9njYDw7mA%3D%3D';
  const odsayKey = 'sKjjRgwggOCqUOMBz6omJ9L0diWbh0WucBzr/O45OU0';
  let startCoords, endCoords;

  $(document).ready(() => {
    const $endInput = $('#end');
    const $endResults = $('#end-results');

    // í˜„ì¬ ìœ„ì¹˜ ì„¤ì •
    navigator.geolocation?.getCurrentPosition(
      pos => {
        startCoords = {
          x: pos.coords.longitude,
          y: pos.coords.latitude
        };
        console.log('í˜„ì¬ ìœ„ì¹˜:', startCoords);
      },
      () => alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
    );

    // ë„ì°©ì§€ ìë™ì™„ì„±
    $endInput.on('keyup', function () {
      const keyword = $(this).val().trim();
      if (keyword.length < 2) return $endResults.empty();

      $.get(`https://apis.openapi.sk.com/tmap/pois`, {
        version: 1,
        searchKeyword: keyword,
        resCoordType: 'WGS84GEO',
        reqCoordType: 'WGS84GEO',
        count: 5,
        appKey: appKey
      }).done(res => {
        const pois = res.searchPoiInfo?.pois?.poi || [];
        $endResults.empty();

        pois.forEach(poi => {
          $("<li>")
            .text(poi.name)
            .on("click", () => {
              endCoords = { x: poi.frontLon, y: poi.frontLat };
              $endResults.empty();
              fetchTransitRoute();
            })
            .appendTo($endResults);
        });
      });
    });
  });

  async function fetchTransitRoute() {
    if (!startCoords || !endCoords) return alert("ì¶œë°œì§€ ë˜ëŠ” ë„ì°©ì§€ ì¢Œí‘œê°€ ì—†ìŠµë‹ˆë‹¤.");

    const url = `https://api.odsay.com/v1/api/searchPubTransPathT?SX=${startCoords.x}&SY=${startCoords.y}&EX=${endCoords.x}&EY=${endCoords.y}&SearchPathType=2&apiKey=${odsayKey}`;

    const response = await $.get(url);
    const paths = response.result?.path?.slice(0, 4);
    if (!paths || paths.length === 0) return alert("ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

    const busArrivalCache = new Map();

    // ëª¨ë“  ê²½ë¡œ ë¶„ì„ (walk, transfers, min1 ë„ì°©ì‹œê°„ í¬í•¨)
    const scoredPaths = await Promise.all(paths.map(async (path) => {
      let walkTime = 0;
      let transfers = path.info.busTransitCount;
      let minArrival = Infinity;

      for (const sub of path.subPath) {
        if (sub.trafficType === 3) {
          walkTime += sub.sectionTime;
        } else if (sub.trafficType === 2) {
          const busNo = sub.lane[0].busNo;
          const stationId = sub.startLocalStationID;
          const cacheKey = `${stationId}_${busNo}`;
          let min1 = 999;

          if (busArrivalCache.has(cacheKey)) {
            min1 = busArrivalCache.get(cacheKey);
          } else {
            try {
              const html = await fetchBusArrivalInfo(stationId, busNo);
              const match = html.match(/(\d+)ë¶„ í›„/);
              if (match) min1 = parseInt(match[1]);
              busArrivalCache.set(cacheKey, min1);
            } catch {
              min1 = 999;
            }
          }

          if (min1 < minArrival) minArrival = min1;
        }
      }

      return {
        path,
        walkTime,
        transfers,
        minArrival,
        totalTime: path.info.totalTime
      };
    }));

    // ìµœë‹¨ ì‹œê°„ ê²½ë¡œ
    const fastest = scoredPaths.reduce((a, b) => (a.totalTime < b.totalTime ? a : b));
    
    // ìµœì  ê²½ë¡œ (ì¡°ê±´ ì •ë ¬)
    const sorted = [...scoredPaths].sort((a, b) => {
      if (a.transfers !== b.transfers) return a.transfers - b.transfers;
      if (a.walkTime !== b.walkTime) return a.walkTime - b.walkTime;
      return a.minArrival - b.minArrival;
    });
    const best = sorted[0];

    const $result = $("#route-result").empty();

    // ë‘ ê²½ë¡œê°€ ë‹¤ë¥´ë©´ ì¶”ì²œ ê²½ë¡œë„ í•¨ê»˜ í‘œì‹œ
    const showFastest = fastest.path.info.totalTime < best.path.info.totalTime;

    if (showFastest) {
      $result.append(`<h2 style="color:#0a58ca;">ğŸš€ ì¶”ì²œ ê²½ë¡œ (ìµœë‹¨ ì†Œìš”ì‹œê°„)</h2>`);
      renderRoute(fastest, busArrivalCache, $result);
    }

    $result.append(`<h2 style="color:#198754;">â­ ìµœì  ê²½ë¡œ (í™˜ìŠ¹/ë„ë³´/ë„ì°©ì‹œê°„ ê¸°ì¤€)</h2>`);
    renderRoute(best, busArrivalCache, $result);
  }

  async function renderRoute(routeData, cache, $container) {
    const { path } = routeData;
    const { totalTime, busTransitCount } = path.info;

    const $card = $(`<div style="margin-bottom:20px;padding:10px;background:#fff;border:1px solid #ccc;border-radius:8px;">
      <h3>ì†Œìš”ì‹œê°„: ${totalTime}ë¶„ (ë²„ìŠ¤ í™˜ìŠ¹ ${busTransitCount}íšŒ)</h3>
    </div>`);

    let totalWalk = 0, totalBus = 0;

    for (const sub of path.subPath) {
      if (sub.trafficType === 3) {
        totalWalk += sub.sectionTime;
        $card.append(`<p>ë„ë³´ ${sub.sectionTime}ë¶„ ì´ë™</p>`);
      } else if (sub.trafficType === 2) {
        const busNo = sub.lane[0].busNo;
        const { startLocalStationID: stationId, startName, endName, endLocalStationID } = sub;
        totalBus += sub.sectionTime;

        const cacheKey = `${stationId}_${busNo}`;
        const $arrival = $(`<div class="bus-arrival">[ë²„ìŠ¤ ë„ì°© ì •ë³´ ë¡œë”© ì¤‘...]</div>`);
        const $bus = $(`
          <div>
            <p><strong>ë²„ìŠ¤ íƒ‘ìŠ¹:</strong> ${busNo}</p>
            <p>ì¶œë°œ: ${startName} (ID: ${stationId}) â†’ ë„ì°©: ${endName} (ID: ${endLocalStationID})</p>
          </div>
        `).append($arrival);
        $card.append($bus);

        if (cache.has(cacheKey)) {
          $arrival.html(`ë„ì°©ê¹Œì§€ ì•½ ${cache.get(cacheKey)}ë¶„`);
        } else {
          try {
            const html = await fetchBusArrivalInfo(stationId, busNo);
            $arrival.html(html);
          } catch (err) {
            $arrival.text("ë„ì°© ì •ë³´ ì˜¤ë¥˜: " + err.message);
          }
        }
      }
    }

    $card.append(`<hr><p>ì´ ë„ë³´ ì‹œê°„: ${totalWalk}ë¶„</p><p>ì´ ë²„ìŠ¤ íƒ‘ìŠ¹ ì‹œê°„: ${totalBus}ë¶„</p>`);
    $container.append($card);
  }


  // ë²„ìŠ¤ ë„ì°© ì •ë³´ ì œê³µ
  function fetchBusArrivalInfo(stationId, busNo) {
      const url = `https://apis.data.go.kr/6260000/BusanBIMS/stopArrByBstopid?bstopid=${stationId}&serviceKey=${busanServiceKey}`;

      return fetch(url)
          .then(res => res.text())
          .then(xmlStr => {
          const parser = new DOMParser();
          const xml = parser.parseFromString(xmlStr, "application/xml");
          const items = [...xml.getElementsByTagName("item")];

          const matches = items.filter(item => getText(item, "lineno") === busNo);
          if (!matches.length) return "í•´ë‹¹ ë²„ìŠ¤ ë„ì°© ì •ë³´ ì—†ìŒ";

          const html = matches.map(item => {
              const car1 = getText(item, "carno1");
              const min1 = getText(item, "min1");
              const car2 = getText(item, "carno2");
              const min2 = getText(item, "min2");
              return `<li>${busNo}ë²ˆ â†’ ì°¨ëŸ‰1: ${car1} (${min1}ë¶„ í›„), ì°¨ëŸ‰2: ${car2} (${min2}ë¶„ í›„)</li>`;
          }).join("");

          return `<ul>${html}</ul>`;
          });
  }

  function getText(parent, tagName) {
      const el = parent.getElementsByTagName(tagName)[0];
      return el ? el.textContent : "ì •ë³´ ì—†ìŒ";
  }

</script>
</body>
</html>
